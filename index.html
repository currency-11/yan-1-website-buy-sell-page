<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0" />
  <title>TradeNest</title>

  <style>
    /* ------------------- Base ------------------- */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fff;                     /* removed the previous #f4f6f8 background */
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin: 0;
      font-size: 2.2rem;
      color: #222;
    }

    .header {
      text-align: center;
      padding: 20px 10px;
    }

    .tagline {
      margin: 10px 0 5px;
      font-size: 1rem;
      background: linear-gradient(45deg,#ff6a00,#ffd600);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      font-weight: 600;
    }

    .highlight {
      margin: 0;
      font-size: 0.95rem;
      color: #0069d9;
    }

    /* ------------------- Buttons ------------------- */
    .button-group {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      padding: 9px 22px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: background .3s;
    }

    button:hover { background:#0056b3; }

    /* ------------------- Search ------------------- */
    .search-container {
      display: none;                     /* shown only on ‚ÄúBuy‚Äù */
      width: 100%;
      max-width: 800px;
      padding: 0 15px;
      margin-bottom: 10px;
      gap: 8px;
      align-items: center;
      display: flex;
    }

    .search-container input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .search-container button {
      flex-shrink: 0;
      font-size: 0.95rem;
    }

    /* ------------------- Sell Form ------------------- */
    #sellForm {
      display: none;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 660px;
      padding: 0 15px;
    }

    #sellForm label {
      font-weight: 600;
      color: #333;
    }

    #sellForm input,
    #sellForm textarea {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 0.95rem;
    }

    #sellForm textarea { resize: vertical; }

    #responseMsg { text-align:center; margin-top:8px; font-weight:600; }
    .success { color:green; }
    .error   { color:red; }

    /* ------------------- Items Grid ------------------- */
    #items-container {
      display: none;
      width: 100%;
      max-width: 1300px;
      padding: 0 15px;
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
      gap: 20px;
    }

    .item-card {
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:10px;
      padding:15px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      position:relative;
    }

    .item-card h3 { margin:0 0 8px; font-size:1.1rem; color:#222; }
    .item-card p{
      margin:4px 0;
      font-size:0.88rem;
      color:#555;
    }

    .item-card a.external-link{
      color:#0069d9;
      text-decoration:underline;
    }

    .media-wrapper{
      margin-bottom:10px;
      overflow:hidden;
    }

    .card-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    .card-actions button{
      font-size:0.85rem;
      padding:5px 10px;
    }

    /* ------------------- Footer ------------------- */
    .footer{
      margin-top:auto;
      padding:12px 0;
      width:100%;
      text-align:center;
      font-size:0.85rem;
      color:#777;
    }

    /* ------------------- Floating Chat ------------------- */
    .chat-button{
      position:fixed;
      right:20px;
      bottom:80px;
      width:60px;
      height:60px;
      background:#007bff;
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:2rem;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      z-index:2000;
    }

    /* ------------------- Feedback Modal ------------------- */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2100;
    }
    .modal.active{ display:flex; }

    .modal-content{
      background:#fff;
      padding:20px 30px;
      border-radius:10px;
      max-width:90%;
      text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
    }

    .modal-content p{ margin:8px 0; font-size:0.95rem; }
    .modal-content a{ color:#0069d9; }

    /* ------------------- Full‚ÄëScreen Embed Modal ------------------- */
    .fullscreen-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.9);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
    }
    .fullscreen-modal.active{ display:flex; }

    .fullscreen-content{
      position:relative;
      width:95%;
      height:95%;
      background:#000;
    }

    .fullscreen-content button{
      position:absolute;
      top:10px;
      right:10px;
      background:rgba(255,255,255,.2);
      border:none;
      color:#fff;
      font-size:1.5rem;
      cursor:pointer;
      border-radius:4px;
    }

    .fullscreen-content iframe{
      width:100%;
      height:100%;
      border:none;
    }

    /* ------------------- Responsive ------------------- */
    @media (max-width:768px){
      h1{font-size:1.9rem}
      .tagline{font-size:0.9rem}
      .highlight{font-size:0.85rem}
      button{font-size:0.9rem;padding:7px 18px}
    }
    @media (max-width:480px){
      h1{font-size:1.6rem}
      .tagline{font-size:0.85rem}
      .highlight{font-size:0.8rem}
    }
  </style>
</head>
<body>

  <!-- ---------- Header ---------- -->
  <header class="header">
    <h1>üõí TradeNest</h1>
    <p class="tagline">‚ÄúA trusted marketplace where buying and selling come together. Discover great deals, list items effortlessly, and connect with real people‚Äîfast, simple, and secure.‚Äù</p>
    <p class="highlight">‚ÄúBuy smarter. Sell faster. Connect instantly.‚Äù</p>
  </header>

  <!-- ---------- Main Buttons ---------- -->
  <div class="button-group">
    <button id="sellBtn">Sell</button>
    <button id="buyBtn">Buy</button>
  </div>

  <!-- ---------- Search (Buy) ---------- -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search by item name...">
    <button id="toggleSearchMode">‚Üí</button>
    <button id="searchBtn">Search</button>
    <button id="backBtn">‚Üê Back</button>
  </div>

  <!-- ---------- Sell Form ---------- -->
  <form id="sellForm">
    <label>Archive URL (only from archive.org)</label>
    <input type="url" id="archive_url"
           placeholder="https://archive.org/details/..."
           required>

    <label>Item</label>
    <input type="text" id="item" required>

    <label>Details</label>
    <textarea id="details" rows="3" required></textarea>

    <label>Discount (%)</label>
    <input type="number" id="discount" min="0" max="100" required>

    <label>Price (‚Çπ)</label>
    <input type="number" id="price" min="0" required>

    <label>Address</label>
    <input type="text" id="address" required>

    <label>Phone Number 1</label>
    <input type="tel" id="phone_number_1" required>

    <label>Phone Number 2</label>
    <input type="tel" id="phone_number_2">

    <label>URL</label>
    <input type="url" id="url" required>

    <label>Disappear Date</label>
    <input type="date" id="disappear_date" required>

    <label>Post</label>
    <textarea id="post" rows="2" placeholder="Enter post text..."
              required></textarea>

    <button type="submit">Submit Post</button>

    <div id="responseMsg"></div>
  </form>

  <!-- ---------- Items Grid (Buy) ---------- -->
  <div id="items-container"></div>

  <!-- ---------- Footer ---------- -->
  <footer class="footer">
    ¬© 2026 TradeNest¬∑ Built with ‚ù§Ô∏è by YAN
  </footer>

  <!-- ---------- Floating Chat ---------- -->
  <div id="chatBtn" class="chat-button">üí¨</div>

  <!-- ---------- Feedback Modal ---------- -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <p>üîê Login or sign up with GitHub to give the feedback.</p>
      <p>üì∫ Or click the video link
        <a href="https://archive.org/details/panfda"
           target="_blank">https://archive.org/details/panfda</a>
        to know how to give feedback.</p>
      <p id="countdown">5</p>
    </div>
  </div>

  <!-- ---------- Full‚ÄëScreen Embed Modal ---------- -->
  <div id="fullscreenModal" class="fullscreen-modal">
    <div class="fullscreen-content">
      <button id="closeFullscreenBtn">‚úñ</button>
      <iframe id="fullscreenIframe" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    /* ==========================================================
       Global constants & state
      ========================================================== */
    const BASE_URL = 'https://buy_sell_metadata_backend.civilwan.workers.dev';
    let cachedItems = null;               // holds items (shuffled)
    let searchMode = 'name';               // 'name' or 'id'

    /* ==========================================================
       DOM references
      ========================================================== */
    const sellBtn          = document.getElementById('sellBtn');
    const buyBtn           = document.getElementById('buyBtn');
    const sellForm         = document.getElementById('sellForm');
    const itemsContainer   = document.getElementById('items-container');
    const searchContainer  = document.querySelector('.search-container');
    const searchInput      = document.getElementById('searchInput');
    const toggleSearchMode = document.getElementById('toggleSearchMode');
    const searchBtn        = document.getElementById('searchBtn');
    const backBtn          = document.getElementById('backBtn');
    const responseMsg      = document.getElementById('responseMsg');
    const archiveInput     = document.getElementById('archive_url');

    const chatBtn          = document.getElementById('chatBtn');
    const feedbackModal    = document.getElementById('feedbackModal');
    const countdownEl      = document.getElementById('countdown');

    const fullscreenModal  = document.getElementById('fullscreenModal');
    const fullscreenIframe = document.getElementById('fullscreenIframe');
    const closeFullscreenBtn = document.getElementById('closeFullscreenBtn');

    /* ==========================================================
       Utility functions
      ========================================================== */
    const esc = txt => (txt ?? '').toString()
                .replace(/&/g,'&amp;')
                .replace(/"/g,'&quot;')
                .replace(/'/g,'&#039;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;');

    function shuffleArray(arr){
      return arr.slice().sort(() => Math.random() - 0.5);
    }

    // Build the proper embed URL for archive.org ‚Äúdetails‚Äù pages
    function getEmbedUrl(url){
      if (!url) return '';
      const match = url.match(/archive\.org\/details\/([^/?]+)/);
      return match ? `https://archive.org/embed/${match[1]}` : url;
    }

    // Build HTML for media preview inside the grid
    function getMediaHtml(url){
      if (!url) return '';
      const escaped = esc(url);
      const ext = url.split('.').pop().split('?')[0].toLowerCase();
      const imgExt = ['png','jpg','jpeg','gif','webp'];
      if (imgExt.includes(ext)) {
        return `<img src="${escaped}" alt="image" loading="lazy"
                style="max-width:100%;max-height:200px;border-radius:6px;">`;
      }
      if (ext === 'mp4') {
        return `<video src="${escaped}" controls
                style="width:100%;max-height:200px;border-radius:6px;"></video>`;
      }
      if (ext === 'mp3') {
        return `<audio src="${escaped}" controls
                style="width:100%;"></audio>`;
      }
      if (ext === 'pdf') {
        return `<embed src="${escaped}" type="application/pdf"
                style="width:100%;height:200px;"></embed>`;
      }
      // archive.org details ‚Üí embed
      const match = url.match(/archive\.org\/details\/([^/?]+)/);
      if (match) {
        const embed = `https://archive.org/embed/${match[1]}`;
        return `<iframe src="${embed}" loading="lazy"
                style="width:100%;height:200px;border:none;"></iframe>`;
      }
      // fallback link
      return `<a href="${escaped}" target="_blank">Open file</a>`;
    }

    // Render an array of items into the grid
    function renderItems(items){
      if (!Array.isArray(items) || items.length === 0) {
        itemsContainer.innerHTML = '<p>No matching items found.</p>';
        return;
      }
      itemsContainer.innerHTML = items.map(item => {
        const id = esc(item.id ?? item._id ?? '');
        const media = getMediaHtml(item.archive_url);
        return `
          <div class="item-card" id="item-${id}">
            <div class="media-wrapper">${media}</div>
            <h3>${esc(item.item)}</h3>
            <p><strong>ID:</strong> ${id}</p>
            <p><strong>Details:</strong> ${esc(item.details)}</p>
            <p><strong>Price:</strong> ‚Çπ${esc(item.price)}</p>
            <p><strong>Discount:</strong> ${esc(item.discount)}%</p>
            <p><strong>Address:</strong> ${esc(item.address)}</p>
            <p><strong>Phone 1:</strong> ${esc(item.phone_number_1)}</p>
            ${item.phone_number_2 ? `<p><strong>Phone 2:</strong> ${esc(item.phone_number_2)}</p>` : ''}
            <p><strong>URL:</strong> <a href="${esc(item.url)}"
               target="_blank" class="external-link">${esc(item.url)}</a></p>
            <p><strong>Disappear Date:</strong> ${esc(item.disappear_date)}</p>
            <p><strong>Post:</strong> ${esc(item.post)}</p>
            <div class="card-actions">
              <button class="fullscreen-btn" data-url="${esc(item.archive_url)}">‚õ∂</button>
              <button class="share-btn" data-id="${id}">üîó Share</button>
            </div>
          </div>`;
      }).join('');
      attachCardListeners();
    }

    // Attach listeners for fullscreen and share buttons
    function attachCardListeners(){
      document.querySelectorAll('.fullscreen-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const url = btn.dataset.url;
          const embed = getEmbedUrl(url);
          fullscreenIframe.src = embed;
          fullscreenModal.classList.add('active');
          document.body.style.overflow = 'hidden';
        });
      });

      document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const shareLink = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/trade-nest-shared-links-redirecting.html?item_id=${encodeURIComponent(id)}`;
          if (navigator.share) {
            navigator.share({
              title: 'TradeNest Item',
              text: 'Check out this item on TradeNest',
              url: shareLink
            }).catch(err => console.warn('Share failed', err));
          } else {
            navigator.clipboard.writeText(shareLink)
              .then(() => alert('Link copied to clipboard!'))
              .catch(() => prompt('Copy the link manually:', shareLink));
          }
        });
      });
    }

    // Scroll to the item that matches the ID passed in the URL
    function scrollToItemFromURL(){
      const params = new URLSearchParams(window.location.search);
      const focusId = params.get('item_id');
      if (!focusId) return;
      setTimeout(() => {
        const el = document.getElementById(`item-${focusId}`);
        if (el) {
          el.scrollIntoView({behavior:'smooth', block:'center'});
          el.style.boxShadow = '0 0 12px 4px rgba(0,123,255,.5)';
          setTimeout(() => el.style.boxShadow = '', 3000);
        }
      }, 500);
    }

    /* ==========================================================
       UI Interaction
      ========================================================== */
    // SELL button ‚Äì show form
    sellBtn.onclick = () => {
      sellForm.style.display = 'flex';
      itemsContainer.style.display = 'none';
      searchContainer.style.display = 'none';
      responseMsg.textContent = '';
    };

    // BUY button ‚Äì show items grid + search bar
    buyBtn.onclick = () => {
      sellForm.style.display = 'none';
      itemsContainer.style.display = 'grid';
      searchContainer.style.display = 'flex';
      responseMsg.textContent = '';
      if (cachedItems) {
        renderItems(cachedItems);
        scrollToItemFromURL();
      } else {
        fetchAndDisplayItems();
      }
    };

    // Toggle between name‚Äësearch and ID‚Äësearch
    toggleSearchMode.onclick = () => {
      if (searchMode === 'name') {
        searchMode = 'id';
        searchInput.placeholder = 'Enter ID...';
        toggleSearchMode.textContent = '‚Üê';
      } else {
        searchMode = 'name';
        searchInput.placeholder = 'Search by item name...';
        toggleSearchMode.textContent = '‚Üí';
      }
    };

    // Execute a search
    searchBtn.onclick = () => {
      const term = searchInput.value.trim().toLowerCase();
      if (!cachedItems) return;

      if (searchMode === 'name') {
        const filtered = cachedItems.filter(it => (it.item ?? '').toLowerCase().includes(term));
        renderItems(filtered);
      } else {
        const filtered = cachedItems.filter(it => String(it.id ?? it._id ?? '') === term);
        renderItems(filtered);
      }
    };

    // BACK button ‚Äì return to the full, un‚Äëfiltered list
    backBtn.onclick = () => {
      if (!cachedItems) return;
      searchInput.value = '';
      renderItems(cachedItems);
    };

    // Fetch items from the backend (shuffle them)
    function fetchAndDisplayItems(){
      itemsContainer.innerHTML = '<p>Loading items‚Ä¶</p>';
      fetch(`${BASE_URL}/api/items`)
        .then(r => r.json())
        .then(data => {
          cachedItems = shuffleArray(data);   // random order
          renderItems(cachedItems);
          scrollToItemFromURL();
        })
        .catch(() => {
          itemsContainer.innerHTML = '<p style="color:red;">Error loading items.</p>';
        });
    }

    // Full‚Äëscreen modal close button
    closeFullscreenBtn.onclick = () => {
      fullscreenModal.classList.remove('active');
      fullscreenIframe.src = '';
      document.body.style.overflow = '';
    };

    // Close fullscreen when clicking outside the content (optional)
    fullscreenModal.addEventListener('click', e => {
      if (e.target === fullscreenModal) {
        closeFullscreenBtn.click();
      }
    });

    /* ==========================================================
       SELL Form submission (no ads)
      ========================================================== */
    sellForm.addEventListener('submit', e => {
      e.preventDefault();
      responseMsg.textContent = '';
      const archiveURL = archiveInput.value.trim();
      if (!archiveURL.startsWith('https://archive.org/') &&
          !archiveURL.startsWith('http://archive.org/')) {
        responseMsg.textContent = '‚ùå Please enter a valid archive.org URL.';
        responseMsg.className = 'error';
        return;
      }

      const metadata = {
        archive_url: archiveURL,
        item: document.getElementById('item').value,
        details: document.getElementById('details').value,
        discount: document.getElementById('discount').value,
        price: document.getElementById('price').value,
        address: document.getElementById('address').value,
        phone_number_1: document.getElementById('phone_number_1').value,
        phone_number_2: document.getElementById('phone_number_2').value,
        url: document.getElementById('url').value,
        disappear_date: document.getElementById('disappear_date').value,
        post: document.getElementById('post').value
      };

      fetch(`${BASE_URL}/api/sell`, {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(metadata)
      })
      .then(r => {
        if (r.ok) {
          responseMsg.textContent = '‚úÖ Post submitted successfully!';
          responseMsg.className = 'success';
          sellForm.reset();
          cachedItems = null; // force fresh fetch on next Buy
        } else {
          responseMsg.textContent = '‚ùå Failed to submit post.';
          responseMsg.className = 'error';
        }
      })
      .catch(() => {
        responseMsg.textContent = '‚ö†Ô∏è Error connecting to backend.';
        responseMsg.className = 'error';
      });
    });

    /* ==========================================================
       Floating chat ‚Üí feedback modal with countdown
      ========================================================== */
    chatBtn.addEventListener('click', () => {
      feedbackModal.classList.add('active');
      let count = 5;
      countdownEl.textContent = count;
      const timer = setInterval(() => {
        count--;
        if (count === 0) {
          clearInterval(timer);
          feedbackModal.classList.remove('active');
          window.open('https://github.com/OpenThoughtVoice/OpenThoughtVoice/discussions/7', '_blank');
        } else {
          countdownEl.textContent = count;
        }
      }, 1000);
    });

    feedbackModal.addEventListener('click', e => {
      if (e.target === feedbackModal) feedbackModal.classList.remove('active');
    });

    /* ==========================================================
       Open Buy view automatically when an item_id is present in URL
      ========================================================== */
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('item_id')) {
        // Force the buy view ‚Äì the scroll will happen after items load
        buyBtn.click();
      }
    });
  </script>
</body>
</html>
